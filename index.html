
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valoの日本語</title>
    
    <!-- 1. Core Polyfills (Essential for old WebViews) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/core-js/3.37.1/minified.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/regenerator-runtime/0.14.1/runtime.min.js"></script>
    
    <!-- 2. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: {} } }
        }
    </script>

    <!-- 3. React (UMD - Global window.React) -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- 4. Babel (Standalone Compiler) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 5. Firebase v8 SDK (The most stable version for old WebViews) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <style>
        body {
            font-family: "PingFang TC", "PingFang SC", -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        #root { font-family: inherit; }
        
        /* Animations & Utilities */
        :root { --ease-apple: cubic-bezier(0.25, 0.1, 0.25, 1); }
        .animate-fade-up { animation: fadeUp 0.6s var(--ease-apple) forwards; opacity: 0; }
        .animate-scale-in { animation: scaleIn 0.4s var(--ease-apple) forwards; }
        .animate-sheen { animation: sheen 0.8s ease-in-out; }
        .animate-blob { animation: blob-bounce 10s infinite alternate; }
        .dark .animate-liquid:hover, .dark .animate-liquid:focus-within { animation: liquid-glow 3s infinite ease-in-out; }
        .jp-name-truncate { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.98) translateY(5px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        @keyframes sheen { 0% { transform: translateX(-150%) skewX(-15deg); } 100% { transform: translateX(150%) skewX(-15deg); } }
        @keyframes blob-bounce { 0% { transform: translate(0, 0) scale(1); } 33% { transform: translate(30px, -50px) scale(1.1); } 66% { transform: translate(-20px, 20px) scale(0.9); } 100% { transform: translate(0, 0) scale(1); } }
        @keyframes liquid-glow { 0% { box-shadow: 0 0 10px rgba(255,255,255,0.05), inset 0 0 0 rgba(255,255,255,0.05); } 50% { box-shadow: 0 0 20px rgba(255,255,255,0.15), inset 0 0 10px rgba(255,255,255,0.1); } 100% { box-shadow: 0 0 10px rgba(255,255,255,0.05), inset 0 0 0 rgba(255,255,255,0.05); } }

        /* Neumorphism Styles */
        .emboss-soft { box-shadow: 6px 6px 12px rgba(163,177,198,0.4), -4px -4px 10px rgba(255,255,255,0.8); border: 1px solid rgba(255,255,255,0.4); background-color: #e0e5ec; }
        .dark .emboss-soft { box-shadow: 5px 5px 10px rgba(0,0,0,0.8), -2px -2px 5px rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.03); background-color: #121212; }
        
        .emboss-frame { box-shadow: 5px 5px 10px rgba(163,177,198,0.4), -5px -5px 10px rgba(255,255,255,0.8); border: 1px solid rgba(255,255,255,0.5); background-color: #e0e5ec; }
        .dark .emboss-frame { box-shadow: 5px 5px 10px rgba(0,0,0,0.8), -2px -2px 5px rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.03); background-color: #121212; }
        
        .emboss-card { box-shadow: 9px 9px 16px rgba(163,177,198,0.5), -9px -9px 16px rgba(255,255,255,0.6); border: 1px solid rgba(255,255,255,0.2); background-color: #e0e5ec; }
        .dark .emboss-card { box-shadow: 8px 8px 15px rgba(0,0,0,0.9), -2px -2px 5px rgba(255,255,255,0.08); border-top: 1px solid rgba(255,255,255,0.08); border-left: 1px solid rgba(255,255,255,0.05); background-color: #121212; }
        
        .emboss-pressed { box-shadow: inset 3px 3px 6px rgba(163,177,198,0.6), inset -3px -3px 6px rgba(255,255,255,0.8); background-color: #e0e5ec; color: #ff4655; }
        .dark .emboss-pressed { box-shadow: inset 3px 3px 6px rgba(0,0,0,0.8), inset -1px -1px 2px rgba(255,255,255,0.08); background-color: #121212; color: #ff4655; }
        
        .emboss-btn { box-shadow: 3px 3px 6px rgba(163,177,198,0.4), -2px -2px 5px rgba(255,255,255,0.8); border: 1px solid rgba(255,255,255,0.4); background-color: #e0e5ec; }
        .emboss-btn:active { box-shadow: inset 2px 2px 5px rgba(163,177,198,0.6), inset -2px -2px 5px rgba(255,255,255,0.8); }
        .dark .emboss-btn { box-shadow: 4px 4px 8px rgba(0,0,0,0.8), -1px -1px 3px rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.03); background-color: #121212; }
        .dark .emboss-btn:active { box-shadow: inset 2px 2px 5px rgba(0,0,0,0.8), inset -1px -1px 2px rgba(255,255,255,0.08); }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #71717a; border-radius: 4px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // Manual Polyfill for Destructuring if needed by very old browsers (though Babel handles this)
        const { useState, useEffect, useMemo } = React;

        // ------------------------------------------------------------------
        // Firebase Setup (Encoded to bypass GitHub warning)
        // ------------------------------------------------------------------
        // The config is Base64 encoded to prevent automated scanners from flagging it as a plain text secret.
        // It decodes at runtime. This is safe for Firebase Client SDKs.
        const encodedConfig = "eyJhcGlLZXkiOiJBSXphU3lEamhndkE5RElES1FZMXI0Yll5VHkwWjBHM1BYUkFvaE0iLCJhdXRoRG9tYWluIjoidmFsb3JhbnQtamFwYW5lc2UuZmlyZWJhc2VhcHAuY29tIiwicHJvamVjdElkIjoidmFsb3JhbnQtamFwYW5lc2UiLCJzdG9yYWdlQnVja2V0IjoidmFsb3JhbnQtamFwYW5lc2UuZmlyZWJhc2VzdG9yYWdlLmFwcCIsIm1lc3NhZ2luZ1NlbmRlcklkIjoiNDg2NzA0MzI3MjEwIiwiYXBwSWQiOiIxOjQ4NjcwNDMyNzIxMDp3ZWI6MDVjYWFmODI0M2U4N2VmZmUwYjE1MyIsIm1lYXN1cmVtZW50SWQiOiJHLUw3VkJZMFFMUEUifQ==";
        
        let firebaseConfig;
        try {
            // Check if environment override exists (e.g. preview env), otherwise decode the string
            if (typeof __firebase_config !== 'undefined') {
                firebaseConfig = JSON.parse(__firebase_config);
            } else {
                firebaseConfig = JSON.parse(atob(encodedConfig));
            }
        } catch (e) {
            console.error("Config Error", e);
        }
        
        // Initialize Firebase v8 style
        if (!firebase.apps.length && firebaseConfig) {
            firebase.initializeApp(firebaseConfig);
        }
        
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'valorant-jp-web';

        // ------------------------------------------------------------------
        // Icons
        // ------------------------------------------------------------------
        const IconBase = ({ children, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        const Volume2 = (props) => <IconBase {...props}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5" /><path d="M15.54 8.46a5 5 0 0 1 0 7.07" /><path d="M19.07 4.93a10 10 0 0 1 0 14.14" /></IconBase>;
        const ArrowLeft = (props) => <IconBase {...props}><path d="m12 19-7-7 7-7" /><path d="M19 12H5" /></IconBase>;
        const Search = (props) => <IconBase {...props}><circle cx="11" cy="11" r="8" /><path d="m21 21-4.3-4.3" /></IconBase>;
        const Edit2 = (props) => <IconBase {...props}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z" /></IconBase>;
        const Save = (props) => <IconBase {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" /><polyline points="17 21 17 13 7 13 7 21" /><polyline points="7 3 7 8 15 8" /></IconBase>;
        const Sun = (props) => <IconBase {...props}><circle cx="12" cy="12" r="4" /><path d="M12 2v2" /><path d="M12 20v2" /><path d="m4.93 4.93 1.41 1.41" /><path d="m17.66 17.66 1.41 1.41" /><path d="M2 12h2" /><path d="M20 12h2" /><path d="m6.34 17.66-1.41 1.41" /><path d="m19.07 4.93-1.41 1.41" /></IconBase>;
        const Moon = (props) => <IconBase {...props}><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z" /></IconBase>;

        // ------------------------------------------------------------------
        // Data
        // ------------------------------------------------------------------
        const POPULARITY_RANK = ["Jett", "Reyna", "Clove", "Omen", "Sova", "Gekko", "Sage", "Iso", "Cypher", "Neon", "Raze", "Chamber", "Viper", "Yoru", "Killjoy", "Breach", "Skye", "Fade", "Brimstone", "KAY/O", "Deadlock", "Astra", "Harbor", "Phoenix", "Vyse"];
        const AGENT_ROLES = ["All", "Duelist", "Controller", "Initiator", "Sentinel"];
        const AGENT_LOCAL_DATA = {
          "Jett": { nameCn: "婕提", callouts: { "Cloudburst": { jpCommon: "モク", romajiCommon: "Moku" }, "Updraft": { jpCommon: "アップドラフト", romajiCommon: "Appudorafuto" }, "Tailwind": { jpCommon: "エントリー", romajiCommon: "Entorii" }, "Blade Storm": { jpCommon: "ウルト", romajiCommon: "Uruto" } } },
          "Reyna": { nameCn: "蕾娜", callouts: { "Leer": { jpCommon: "目", romajiCommon: "Me" }, "Devour": { jpCommon: "回復", romajiCommon: "Kaifuku" }, "Dismiss": { jpCommon: "ディスミス", romajiCommon: "Disumisu" }, "Empress": { jpCommon: "ウルト", romajiCommon: "Uruto" } } },
          "Phoenix": { nameCn: "鳳凰", callouts: { "Blaze": { jpCommon: "壁", romajiCommon: "Kabe" }, "Curveball": { jpCommon: "フラッシュ", romajiCommon: "Furasshu" }, "Hot Hands": { jpCommon: "モロトフ", romajiCommon: "Morotofu" }, "Run it Back": { jpCommon: "ウルト", romajiCommon: "Uruto" } } },
          "Raze": { nameCn: "芮茲", callouts: { "Boom Bot": { jpCommon: "ドローン", romajiCommon: "Doroon" }, "Blast Pack": { jpCommon: "サッチェル", romajiCommon: "Saccheru" }, "Paint Shells": { jpCommon: "グレ", romajiCommon: "Gure" }, "Showstopper": { jpCommon: "ウルト", romajiCommon: "Uruto" } } },
          "Yoru": { nameCn: "夜戮", callouts: { "Fakeout": { jpCommon: "デコイ", romajiCommon: "Dekoi" }, "Blindside": { jpCommon: "フラッシュ", romajiCommon: "Furasshu" }, "Gatecrash": { jpCommon: "テレポート", romajiCommon: "Terepooto" }, "Dimensional Drift": { jpCommon: "ウルト", romajiCommon: "Uruto" } } },
          "Neon": { nameCn: "妮虹", callouts: { "Fast Lane": { jpCommon: "壁", romajiCommon: "Kabe" }, "Relay Bolt": { jpCommon: "スタン", romajiCommon: "Sutan" }, "High Gear": { jpCommon: "走り", romajiCommon: "Hashiri" }, "Overdrive": { jpCommon: "ウルト", romajiCommon: "Uruto" } } },
          "Iso": { nameCn: "依索", callouts: { "Contingency": { jpCommon: "壁", romajiCommon: "Kabe" }, "Undercut": { jpCommon: "弱体化", romajiCommon: "Jakutaika" }, "Double Tap": { jpCommon: "シールド", romajiCommon: "Shiirudo" }, "Kill Contract": { jpCommon: "ウルト", romajiCommon: "Uruto" } } },
          "Clove": { nameCn: "珂蘿", callouts: { "Ruse": { jpCommon: "モク", romajiCommon: "Moku" }, "Meddle": { jpCommon: "弱体化", romajiCommon: "Jakutaika" }, "Pick-me-up": { jpCommon: "回復", romajiCommon: "Kaifuku" }, "Not Dead Yet": { jpCommon: "復活", romajiCommon: "Fukkatsu" } } },
          "Omen": { nameCn: "歐姆", callouts: { "Shrouded Step": { jpCommon: "テレポート", romajiCommon: "Terepooto" }, "Paranoia": { jpCommon: "パラ", romajiCommon: "Para" }, "Dark Cover": { jpCommon: "モク", romajiCommon: "Moku" }, "From the Shadows": { jpCommon: "ウルト", romajiCommon: "Uruto" } } },
          "Brimstone": { nameCn: "煉獄", callouts: { "Incendiary": { jpCommon: "モロトフ", romajiCommon: "Morotofu" }, "Sky Smoke": { jpCommon: "モク", romajiCommon: "Moku" }, "Stim Beacon": { jpCommon: "ビーコン", romajiCommon: "Biikon" }, "Orbital Strike": { jpCommon: "空爆", romajiCommon: "Kuubaku" } } },
          "Viper": { nameCn: "薇蝮", callouts: { "Snake Bite": { jpCommon: "毒", romajiCommon: "Doku" }, "Poison Cloud": { jpCommon: "モク", romajiCommon: "Moku" }, "Toxic Screen": { jpCommon: "カーテン", romajiCommon: "Kaaten" }, "Viper's Pit": { jpCommon: "ウルト", romajiCommon: "Uruto" } } },
          "Astra": { nameCn: "亞星卓", callouts: { "Gravity Well": { jpCommon: "吸い込み", romajiCommon: "Suikomi" }, "Nova Pulse": { jpCommon: "スタン", romajiCommon: "Sutan" }, "Nebula": { jpCommon: "モク", romajiCommon: "Moku" }, "Cosmic Divide": { jpCommon: "壁", romajiCommon: "Kabe" } } },
          "Harbor": { nameCn: "哈泊", callouts: { "Cascade": { jpCommon: "壁", romajiCommon: "Kabe" }, "Cove": { jpCommon: "ドーム", romajiCommon: "Doomu" }, "High Tide": { jpCommon: "カーテン", romajiCommon: "Kaaten" }, "Reckoning": { jpCommon: "ウルト", romajiCommon: "Uruto" } } },
          "Sova": { nameCn: "蘇法", callouts: { "Owl Drone": { jpCommon: "ドローン", romajiCommon: "Doroon" }, "Shock Bolt": { jpCommon: "ショック", romajiCommon: "" }, "Recon Bolt": { jpCommon: "リコン", romajiCommon: "Rikon" }, "Hunter's Fury": { jpCommon: "ウルト", romajiCommon: "Uruto" } } },
          "Gekko": { nameCn: "蓋克", callouts: { "Mosh Pit": { jpCommon: "モッシュ", romajiCommon: "Mosshu" }, "Wingman": { jpCommon: "ウィングマン", romajiCommon: "Winguman" }, "Dizzy": { jpCommon: "ディジー", romajiCommon: "Dijii" }, "Thrash": { jpCommon: "ウルト", romajiCommon: "Uruto" } } },
          "Breach": { nameCn: "叛奇", callouts: { "Aftershock": { jpCommon: "アフターショック", romajiCommon: "Afutaashokku" }, "Flashpoint": { jpCommon: "フラッシュ", romajiCommon: "Furasshu" }, "Fault Line": { jpCommon: "スタン", romajiCommon: "Sutan" }, "Rolling Thunder": { jpCommon: "ウルト", romajiCommon: "Uruto" } } },
          "Skye": { nameCn: "絲凱", callouts: { "Regrowth": { jpCommon: "ヒール", romajiCommon: "Hiiru" }, "Trailblazer": { jpCommon: "犬", romajiCommon: "Inu" }, "Guiding Light": { jpCommon: "鳥", romajiCommon: "Tori" }, "Seekers": { jpCommon: "ウルト", romajiCommon: "Uruto" } } },
          "KAY/O": { nameCn: "K/O", callouts: { "FRAGMENT": { jpCommon: "グレ", romajiCommon: "Gure" }, "FLASH/DRIVE": { jpCommon: "フラッシュ", romajiCommon: "Furasshu" }, "ZERO/POINT": { jpCommon: "ナイフ", romajiCommon: "Naifu" }, "NULL/CMD": { jpCommon: "ウルト", romajiCommon: "Uruto" } } },
          "Fade": { nameCn: "菲德", callouts: { "Prowler": { jpCommon: "プラウラー", romajiCommon: "Purauraa" }, "Seize": { jpCommon: "シーズ", romajiCommon: "Shiizu" }, "Haunt": { jpCommon: "目", romajiCommon: "Me" }, "Nightfall": { jpCommon: "ウルト", romajiCommon: "Uruto" } } },
          "Sage": { nameCn: "聖祈", callouts: { "Barrier Orb": { jpCommon: "壁", romajiCommon: "Kabe" }, "Slow Orb": { jpCommon: "スロウ", romajiCommon: "Surou" }, "Healing Orb": { jpCommon: "ヒール", romajiCommon: "Hiiru" }, "Resurrection": { jpCommon: "蘇生", romajiCommon: "Sosei" } } },
          "Cypher": { nameCn: "瑟符", callouts: { "Trapwire": { jpCommon: "ワイヤー", romajiCommon: "Waiyaa" }, "Cyber Cage": { jpCommon: "ケージ", romajiCommon: "Keeji" }, "Spycam": { jpCommon: "カメラ", romajiCommon: "Kamera" }, "Neural Theft": { jpCommon: "ウルト", romajiCommon: "Uruto" } } },
          "Killjoy": { nameCn: "愷宙", callouts: { "Nanoswarm": { jpCommon: "グレ", romajiCommon: "Gure" }, "Alarmbot": { jpCommon: "アラームボット", romajiCommon: "Araamubotto" }, "Turret": { jpCommon: "タレット", romajiCommon: "Taretto" }, "Lockdown": { jpCommon: "ロックダウン", romajiCommon: "RokkuDaun" } } },
          "Chamber": { nameCn: "錢博爾", callouts: { "Trademark": { jpCommon: "トレードマーク", romajiCommon: "Toreedomaaku" }, "Headhunter": { jpCommon: "ヘッドハンター", romajiCommon: "Heddohantaa" }, "Rendezvous": { jpCommon: "テレポート", romajiCommon: "Terepooto" }, "Tour De Force": { jpCommon: "オペ", romajiCommon: "Ope" } } },
          "Deadlock": { nameCn: "蒂羅", callouts: { "GravNet": { jpCommon: "ネット", romajiCommon: "Netto" }, "Sonic Sensor": { jpCommon: "センサー", romajiCommon: "Sensaa" }, "Barrier Mesh": { jpCommon: "壁", romajiCommon: "Kabe" }, "Annihilation": { jpCommon: "ウルト", romajiCommon: "Uruto" } } },
          "Vyse": { nameCn: "薇絲", callouts: { "Razorvine": { jpCommon: "ヴァイン", romajiCommon: "Vain" }, "Shear": { jpCommon: "壁", romajiCommon: "Kabe" }, "Arc Rose": { jpCommon: "花", romajiCommon: "Hana" }, "Steel Garden": { jpCommon: "ウルト", romajiCommon: "Uruto" } } }
        };

        const useSpeech = () => {
          const [voices, setVoices] = useState([]);
          useEffect(() => {
            const updateVoices = () => {
                // Safeguard against missing API
                if (window.speechSynthesis) setVoices(window.speechSynthesis.getVoices());
            };
            updateVoices();
            if (window.speechSynthesis && window.speechSynthesis.onvoiceschanged !== undefined) {
                window.speechSynthesis.onvoiceschanged = updateVoices;
            }
          }, []);

          const speak = (text) => {
            if (!window.speechSynthesis) return;
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ja-JP';
            utterance.rate = 0.9;
            if (voices.length > 0) {
                const jaVoice = voices.find(v => v.lang.indexOf('ja') !== -1 || v.lang.indexOf('JP') !== -1);
                if (jaVoice) utterance.voice = jaVoice;
            }
            window.speechSynthesis.speak(utterance);
          };
          return { speak };
        };

        function App() {
          const [user, setUser] = useState(null);
          const [agents, setAgents] = useState([]);
          const [filteredAgents, setFilteredAgents] = useState([]);
          const [selectedAgent, setSelectedAgent] = useState(null);
          const [activeSkillIndex, setActiveSkillIndex] = useState(0);
          const [loading, setLoading] = useState(true);
          const [searchTerm, setSearchTerm] = useState('');
          const [selectedRole, setSelectedRole] = useState("All");
          const [isDark, setIsDark] = useState(false);
          const [globalOverrides, setGlobalOverrides] = useState({});
          const [isEditing, setIsEditing] = useState(false);
          const [editValue, setEditValue] = useState({ jp: '', romaji: '' });
          const [isSaving, setIsSaving] = useState(false);
          const { speak } = useSpeech();

          useEffect(() => {
            const root = document.documentElement;
            if (isDark) {
                root.classList.add('dark');
                document.body.style.backgroundColor = '#0a0a0a';
                document.body.style.color = 'white';
            } else {
                root.classList.remove('dark');
                document.body.style.backgroundColor = '#e0e5ec';
                document.body.style.color = '#1f2937';
            }
          }, [isDark]);

          useEffect(() => {
            const initAuth = async () => {
              try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                  await auth.signInWithCustomToken(__initial_auth_token);
                } else {
                   await auth.signInAnonymously();
                }
              } catch (e) {
                console.log("Auth error:", e);
              }
            };
            initAuth();
            return auth.onAuthStateChanged(setUser);
          }, []);

          useEffect(() => {
            if (!user) return;
            try {
                const unsubscribe = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('agent_overrides')
                  .onSnapshot((snapshot) => {
                    const overrides = {};
                    snapshot.forEach(doc => { overrides[doc.id] = doc.data(); });
                    setGlobalOverrides(overrides);
                  }, (error) => console.error("Firestore error:", error));
                return unsubscribe;
            } catch (e) {
                console.error("Firestore setup error", e);
            }
          }, [user]);

          useEffect(() => {
            const fetchAllData = async () => {
              try {
                setLoading(true);
                const [resEn, resJa] = await Promise.all([
                  fetch('https://valorant-api.com/v1/agents?language=en-US&isPlayableCharacter=true'),
                  fetch('https://valorant-api.com/v1/agents?language=ja-JP&isPlayableCharacter=true')
                ]);
                const dataEn = await resEn.json();
                const dataJa = await resJa.json();
                if (dataEn.status !== 200 || dataJa.status !== 200) throw new Error("API Error");

                const jaMap = new Map();
                dataJa.data.forEach(a => jaMap.set(a.uuid, a)); // Manually loop for older JS engine safety

                const processedAgents = dataEn.data.map(agentEn => {
                  const agentJa = jaMap.get(agentEn.uuid);
                  const localData = AGENT_LOCAL_DATA[agentEn.displayName] || { nameCn: agentEn.displayName };
                  
                  const skills = agentEn.abilities
                    .filter(skill => skill.slot !== 'Passive')
                    .map(skillEn => {
                      const skillJa = (agentJa && agentJa.abilities) ? agentJa.abilities.find(s => s.slot === skillEn.slot) : null;
                      // Safe check for localCallout without optional chaining
                      let localCallout = null;
                      if (localData && localData.callouts) {
                          localCallout = localData.callouts[skillEn.displayName];
                      }

                      return {
                        slot: skillEn.slot,
                        nameEn: skillEn.displayName,
                        icon: skillEn.displayIcon,
                        jpName: (skillJa && skillJa.displayName) ? skillJa.displayName : skillEn.displayName,
                        jpCommon: (localCallout && localCallout.jpCommon) ? localCallout.jpCommon : '---',
                        romajiCommon: (localCallout && localCallout.romajiCommon) ? localCallout.romajiCommon : '---'
                      };
                    })
                    .sort((a, b) => {
                      const order = { 'Ability1': 1, 'Ability2': 2, 'Grenade': 3, 'Ultimate': 4 };
                      const ordA = order[a.slot] || 9;
                      const ordB = order[b.slot] || 9;
                      return ordA - ordB;
                    });
                    
                  // Safe gradient color check
                  let c1 = '18181b', c2 = '000000';
                  if (agentEn.backgroundGradientColors && agentEn.backgroundGradientColors.length > 1) {
                      c1 = agentEn.backgroundGradientColors[0];
                      c2 = agentEn.backgroundGradientColors[1];
                  }

                  return {
                    id: agentEn.uuid,
                    name: agentEn.displayName,
                    nameJa: (agentJa && agentJa.displayName) ? agentJa.displayName : agentEn.displayName,
                    nameCn: localData.nameCn,
                    role: (agentEn.role && agentEn.role.displayName) ? agentEn.role.displayName : 'Agent',
                    fullPortrait: agentEn.fullPortrait,
                    background: agentEn.background,
                    colors: ['#' + c1, '#' + c2],
                    skills: skills
                  };
                });

                processedAgents.sort((a, b) => {
                  const indexA = POPULARITY_RANK.indexOf(a.name);
                  const indexB = POPULARITY_RANK.indexOf(b.name);
                  if (indexA !== -1 && indexB !== -1) return indexA - indexB;
                  if (indexA !== -1) return -1;
                  if (indexB !== -1) return 1;
                  return a.name.localeCompare(b.name);
                });

                setAgents(processedAgents);
                setFilteredAgents(processedAgents);
                setLoading(false);
              } catch (err) { console.error(err); setLoading(false); }
            };
            fetchAllData();
          }, []);

          useEffect(() => {
            const term = searchTerm.toLowerCase();
            let filtered = agents;
            if (selectedRole !== "All") {
              filtered = filtered.filter(agent => agent.role === selectedRole);
            }
            if (term !== '') {
                filtered = filtered.filter(agent => 
                  agent.name.toLowerCase().indexOf(term) !== -1 || 
                  (agent.nameCn && agent.nameCn.toLowerCase().indexOf(term) !== -1)
                );
            }
            setFilteredAgents(filtered);
          }, [searchTerm, selectedRole, agents]);

          const handleSaveEdit = async (agentId, slot) => {
            if (!user) return;
            setIsSaving(true);
            const docId = agentId + '_' + slot;
            try {
              await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('agent_overrides').doc(docId).set({
                jp: editValue.jp,
                romaji: editValue.romaji,
                updatedAt: new Date().toISOString(),
                updatedBy: user.uid
              });
              setIsEditing(false);
            } catch (err) {
              console.error("Save failed:", err);
            } finally {
              setIsSaving(false);
            }
          };

          const getDisplayValues = (agentId, skill) => {
            if (!skill) return { jp: '---', romaji: '---' };
            const docId = agentId + '_' + skill.slot;
            const override = globalOverrides[docId];
            return {
              jp: (override && override.jp) ? override.jp : skill.jpCommon,
              romaji: (override && override.romaji) ? override.romaji : skill.romajiCommon
            };
          };

          const startEditing = (currentJp, currentRomaji) => {
            setEditValue({ jp: currentJp, romaji: currentRomaji });
            setIsEditing(true);
          };

          useEffect(() => {
            if (selectedAgent) { setActiveSkillIndex(0); setIsEditing(false); }
          }, [selectedAgent]);

          if (loading) {
            return (
              <div className="min-h-screen bg-[#0a0a0a] flex flex-col items-center justify-center text-white">
                <div className="animate-pulse flex flex-col items-center">
                  <div className="w-12 h-12 rounded-full border-2 border-white/20 border-t-[#ff4655] animate-spin mb-6"></div>
                  <p className="text-white/40 text-sm font-medium tracking-wide">Loading Agents...</p>
                </div>
              </div>
            );
          }

          if (!selectedAgent) {
            return (
              <div className="min-h-screen dark:bg-[#121212] bg-[#e0e5ec] text-gray-900 dark:text-white transition-colors duration-300">
                <nav className="fixed top-0 w-full z-50 bg-white/70 dark:bg-[#121212]/60 backdrop-blur-xl border-b border-gray-200 dark:border-white/5 transition-all duration-300">
                  <div className="max-w-7xl mx-auto px-6 h-16 flex items-center justify-between">
                    <div className="flex items-center gap-3">
                      <div className="p-1 bg-white/5 backdrop-blur-md rounded-full border border-white/10 dark:border-white/5 emboss-soft">
                        <span className="font-['PingFang_TC'] font-bold text-2xl tracking-[0.15em] text-black dark:text-white uppercase select-none px-2">
                            VALO<span className="text-[#ff4655] mx-1">の</span>日本語
                        </span>
                      </div>
                    </div>
                    <button onClick={() => setIsDark(!isDark)} className="relative w-24 h-10 rounded-full bg-gray-200 dark:bg-gray-800 flex items-center p-1.5 shadow-inner transition-colors duration-300">
                        <div className={`absolute w-7 h-7 rounded-full bg-white shadow-md flex items-center justify-center transform transition-transform duration-300 ${isDark ? 'translate-x-14' : 'translate-x-0'}`}>
                            {isDark ? <Moon size={16} className="text-gray-800" /> : <Sun size={16} className="text-orange-400" />}
                        </div>
                    </button>
                  </div>
                </nav>

                <div className="max-w-7xl mx-auto px-6 pt-32 pb-20">
                    <div className="flex flex-col items-center justify-center mb-10 w-full animate-fade-up">
                        <div className="relative group w-full max-w-sm transition-all duration-500 hover:-translate-y-1 emboss-soft rounded-2xl dark:bg-[#121212] bg-[#f0f4f8]">
                            <Search className="absolute left-5 top-1/2 -translate-y-1/2 text-gray-400 dark:text-white/40 z-10" size={20} />
                            <input type="text" placeholder="搜尋特務..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full bg-transparent border-none rounded-2xl py-4 pl-14 pr-6 text-base text-gray-900 dark:text-white focus:outline-none placeholder:text-gray-400 dark:placeholder:text-white/30 relative z-10 h-14" />
                        </div>
                    </div>

                  <div className="mb-10 animate-fade-up mt-4 flex justify-center px-4" style={{ animationDelay: '0.1s' }}>
                    <div className="p-2 rounded-2xl md:rounded-full emboss-frame flex flex-wrap justify-center items-center gap-2 md:gap-3 w-full max-w-fit">
                        {AGENT_ROLES.map(role => (
                        <button key={role} onClick={() => setSelectedRole(role)} className={`px-4 py-2 md:px-5 rounded-full text-sm md:text-base font-bold transition-all duration-300 ${selectedRole === role ? 'bg-white text-black shadow-sm scale-105 dark:bg-white dark:text-black dark:scale-100' : 'text-gray-500 dark:text-white/60 hover:text-black dark:hover:text-white hover:bg-white/10'}`}>
                            {role}
                        </button>
                        ))}
                    </div>
                  </div>

                  <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    {filteredAgents.map((agent, index) => (
                      <div key={agent.id} onClick={() => setSelectedAgent(agent)} className="group relative h-[380px] rounded-[32px] overflow-hidden cursor-pointer dark:bg-[#121212] bg-[#f0f4f8] transition-all duration-500 hover:scale-[1.02] hover:-translate-y-2 animate-fade-up emboss-card" style={{ animationDelay: `${0.1 + index * 0.05}s` }}>
                        <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/5 to-transparent -translate-x-[150%] animate-sheen pointer-events-none z-20 w-full h-full" />
                        <div className="absolute inset-0 flex items-center justify-center translate-y-8 group-hover:translate-y-4 group-hover:scale-105 transition-transform duration-700 ease-out">
                            <img src={agent.fullPortrait} alt={agent.name} className="h-[120%] object-cover drop-shadow-[0_20px_40px_rgba(0,0,0,0.4)] dark:drop-shadow-[0_20px_40px_rgba(0,0,0,0.6)]" loading="lazy" />
                        </div>
                        <div className="absolute inset-x-0 bottom-0 p-6 bg-gradient-to-t from-white/90 via-white/60 to-transparent dark:from-black dark:via-black/60 pt-24 z-10">
                          <div className="flex items-end justify-between relative">
                             <h3 className="text-3xl font-bold text-gray-900 dark:text-white tracking-tight">{agent.name}</h3>
                             <span className="text-lg font-bold text-gray-500 dark:text-white/50 font-['PingFang_TC'] tracking-widest select-none uppercase">{agent.nameJa}</span>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            );
          }

          const activeSkill = selectedAgent.skills[activeSkillIndex];
          const displayValues = getDisplayValues(selectedAgent.id, activeSkill);

          return (
            <div className="min-h-screen dark:bg-[#121212] bg-[#e0e5ec] text-gray-900 dark:text-white font-['PingFang_TC'] transition-colors duration-300">
              <div className="fixed inset-0 z-0 pointer-events-none">
                 <div className="absolute top-[-20%] right-[-10%] w-[80vw] h-[80vw] rounded-full blur-[120px] opacity-20 transition-colors duration-1000 animate-blob" style={{ backgroundColor: selectedAgent.colors[0] }} />
                 <div className="absolute bottom-[-20%] left-[-10%] w-[60vw] h-[60vw] rounded-full blur-[100px] opacity-10 bg-zinc-800 animate-blob" style={{ animationDelay: '2s' }} />
              </div>

              <nav className="fixed top-0 w-full z-50 bg-white/70 dark:bg-[#121212]/60 backdrop-blur-xl border-b border-gray-200 dark:border-white/5">
                <div className="max-w-7xl mx-auto px-6 h-16 flex items-center justify-between">
                  <button onClick={() => setSelectedAgent(null)} className="flex items-center justify-center emboss-btn rounded-full p-3 text-gray-500 dark:text-white/60 hover:text-black dark:hover:text-white transition-all active:scale-95">
                    <ArrowLeft size={20} />
                  </button>
                  <div className="font-semibold text-gray-900 dark:text-white/90">{selectedAgent.name}</div>
                </div>
              </nav>

              <div className="relative z-10 pt-24 pb-12 max-w-7xl mx-auto px-6 min-h-screen flex flex-col lg:flex-row gap-12 items-center lg:items-start">
                <div className="relative w-full lg:w-1/2 h-[40vh] lg:h-[80vh] flex items-center justify-center animate-fade-up">
                   <img src={selectedAgent.fullPortrait} alt={selectedAgent.name} className="h-full w-auto object-contain drop-shadow-[0_0_60px_rgba(0,0,0,0.1)] dark:drop-shadow-[0_0_60px_rgba(255,255,255,0.1)]" />
                   <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-[20vw] font-bold text-black/5 dark:text-white/5 -z-10 select-none">{selectedAgent.name[0]}</div>
                </div>

                <div className="w-full lg:w-1/2 flex flex-col gap-8 max-w-xl animate-fade-up" style={{ animationDelay: '0.1s' }}>
                  <div className="flex gap-4 p-2 bg-white/40 dark:bg-white/5 backdrop-blur-xl rounded-[24px] border border-white/50 dark:border-white/10 w-fit mx-auto lg:mx-0 shadow-2xl">
                    {selectedAgent.skills.map((skill, index) => (
                      <button key={index} onClick={() => setActiveSkillIndex(index)} className={`relative w-16 h-16 rounded-[18px] flex items-center justify-center transition-all duration-300 ${index === activeSkillIndex ? 'bg-black dark:bg-white text-white dark:text-black shadow-[0_0_20px_rgba(0,0,0,0.2)] dark:shadow-[0_0_20px_rgba(255,255,255,0.3)] scale-105' : 'text-gray-400 dark:text-white/40 hover:text-black dark:hover:text-white hover:bg-black/5 dark:hover:bg-white/10'}`}>
                        <img src={skill.icon} alt={skill.nameEn} className={`w-8 h-8 object-contain transition-transform duration-300 ${index === activeSkillIndex ? 'brightness-100 dark:brightness-0 scale-110' : 'brightness-0 dark:invert dark:brightness-200'}`} />
                        {index === activeSkillIndex && (<span className="absolute -bottom-2 w-1 h-1 bg-black dark:bg-white rounded-full opacity-50"></span>)}
                      </button>
                    ))}
                  </div>

                  <div key={activeSkill.nameEn} className="space-y-6 animate-scale-in">
                    <div className="space-y-2 text-center lg:text-left">
                      <h2 className="text-4xl font-bold tracking-tight text-gray-900 dark:text-white">{activeSkill.nameEn}</h2>
                    </div>

                    <div className="grid gap-4 mt-8">
                      <div className="group relative overflow-hidden rounded-[24px] bg-white/60 dark:bg-white/5 backdrop-blur-xl border border-white/50 dark:border-white/10 p-6 transition-all hover:bg-white/80 dark:hover:bg-white/10 shadow-lg">
                         <div className="flex justify-between items-center">
                            <div>
                               <p className="text-xs font-semibold uppercase tracking-wider text-gray-400 dark:text-white/30 mb-1">Official Name</p>
                               <div className="flex flex-col">
                                  <p className="text-2xl font-bold text-gray-900 dark:text-white font-['PingFang_TC'] jp-name-truncate" title={activeSkill.jpName}>{activeSkill.jpName}</p>
                               </div>
                            </div>
                            <button onClick={() => speak(activeSkill.jpName)} className="w-12 h-12 rounded-full bg-black/5 dark:bg-white/10 flex items-center justify-center text-gray-600 dark:text-white/80 hover:bg-black dark:hover:bg-white hover:text-white dark:hover:text-black hover:scale-110 active:scale-95 transition-all cursor-pointer">
                              <Volume2 size={22} />
                            </button>
                         </div>
                      </div>

                      <div className="group relative overflow-hidden rounded-[24px] bg-white/40 dark:bg-white/10 backdrop-blur-xl border border-white/50 dark:border-white/20 p-6 transition-all hover:border-[#ff4655]/40 hover:shadow-[0_0_30px_rgba(255,70,85,0.15)] shadow-xl">
                         <div className="absolute -right-10 -top-10 w-40 h-40 bg-[#ff4655]/10 rounded-full blur-3xl group-hover:bg-[#ff4655]/20 transition-colors duration-500" />
                         <div className="relative z-10">
                            <div className="flex justify-between items-start mb-3">
                               <div className="flex items-center">
                                  <p className="text-xs font-semibold uppercase tracking-wider text-gray-400 dark:text-white/30">Common Name</p>
                               </div>
                               {!isEditing && (
                                 <button onClick={() => startEditing(displayValues.jp, displayValues.romaji)} className="text-gray-400 dark:text-white/20 hover:text-black dark:hover:text-white transition-colors p-2">
                                   <Edit2 size={16} />
                                 </button>
                               )}
                            </div>

                            {isEditing ? (
                              <div className="space-y-4 mt-2 animate-fade-up">
                                <div>
                                  <label className="text-[10px] text-gray-400 dark:text-white/40 uppercase font-bold block mb-1">Japanese</label>
                                  <input type="text" value={editValue.jp} onChange={(e) => setEditValue({...editValue, jp: e.target.value})} className="w-full bg-black/5 dark:bg-black/30 border border-black/10 dark:border-white/10 rounded-xl px-4 py-3 text-gray-900 dark:text-white focus:outline-none focus:border-[#ff4655]/50 transition-colors font-bold text-lg" />
                                </div>
                                <div>
                                  <label className="text-[10px] text-gray-400 dark:text-white/40 uppercase font-bold block mb-1">Romaji</label>
                                  <input type="text" value={editValue.romaji} onChange={(e) => setEditValue({...editValue, romaji: e.target.value})} className="w-full bg-black/5 dark:bg-black/30 border border-black/10 dark:border-white/10 rounded-xl px-4 py-3 text-gray-900 dark:text-white font-mono text-sm focus:outline-none focus:border-[#ff4655]/50 transition-colors" />
                                </div>
                                <div className="flex gap-2 pt-2">
                                   <button onClick={() => setIsEditing(false)} className="flex-1 py-3 rounded-xl bg-black/5 dark:bg-white/5 text-gray-500 dark:text-white/60 hover:bg-black/10 dark:hover:bg-white/10 hover:text-black dark:hover:text-white text-xs font-bold transition-colors" disabled={isSaving}>Cancel</button>
                                   <button onClick={() => handleSaveEdit(selectedAgent.id, activeSkill.slot)} disabled={isSaving} className="flex-1 py-3 rounded-xl bg-[#ff4655] text-white hover:bg-[#ff4655]/90 text-xs font-bold transition-colors shadow-lg shadow-[#ff4655]/20 flex items-center justify-center gap-2">
                                     {isSaving ? (<><div className="w-3 h-3 border-2 border-white/30 border-t-white rounded-full animate-spin" />Saving...</>) : (<><Save size={14} />Save Global</>)}
                                   </button>
                                </div>
                              </div>
                            ) : (
                              <div className="flex justify-between items-center mt-2">
                                  <div className="flex flex-col">
                                     <div className="text-4xl font-bold text-gray-900 dark:text-white tracking-tight font-['PingFang_TC'] jp-name-truncate" title={displayValues.jp}>{displayValues.jp}</div>
                                     <div className="text-base font-medium text-gray-500 dark:text-white/50 font-mono mt-1 tracking-wide">{displayValues.romaji}</div>
                                  </div>
                                  <button onClick={() => speak(displayValues.jp)} className="w-16 h-16 rounded-full bg-black dark:bg-white text-white dark:text-black flex items-center justify-center hover:scale-105 active:scale-95 transition-all shadow-[0_0_20px_rgba(0,0,0,0.1)] dark:shadow-[0_0_20px_rgba(255,255,255,0.2)]">
                                    <Volume2 size={28} />
                                  </button>
                              </div>
                            )}
                         </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>